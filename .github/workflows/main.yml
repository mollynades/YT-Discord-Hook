name: YouTubeÂ â†’ DiscordÂ Notifier

on:
  schedule:
    - cron: '*/10 * * * *'   # 10ë¶„ë§ˆë‹¤
  workflow_dispatch:         # í´ë¦­í•´ì„œ ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # 1) ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v2

      # 2) jq ì„¤ì¹˜(ê°„ë‹¨ JSON íŒŒì‹±ìš©)
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 3) ìµœì‹  ì˜ìƒ ê°€ì ¸ì˜¤ê¸° + ì´ì „ URL ë¹„êµ
      - name: Check latest video
        id: get_video
        run: |
          CHANNEL_ID="UCHKW0jcgmONEp7-KQ-0T8IA"
          FEED_URL="https://www.youtube.com/feeds/videos.xml?channel_id=$CHANNEL_ID"

          # RSSì—ì„œ ì²« ë²ˆì§¸ <entry> ë¸”ë¡ì˜ video URL ë½‘ê¸°
          LATEST_URL=$(curl -s "$FEED_URL" \
            | sed -n 's:.*<link rel="alternate" href="\([^"]*\)".*:\1:p' \
            | head -n 1)

          # ì—†ìœ¼ë©´ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
          if [ -z "$LATEST_URL" ]; then
            echo "âŒ ì˜ìƒ URL ì¶”ì¶œ ì‹¤íŒ¨"; exit 1
          fi

          # ì´ì „ ì „ì†¡ ê¸°ë¡ í™•ì¸
          if [ -f last_notified.json ]; then
            LAST_URL=$(jq -r '.url' last_notified.json)
          else
            LAST_URL=""
          fi

          echo "LATEST_URL=$LATEST_URL" >> "$GITHUB_ENV"
          echo "LAST_URL=$LAST_URL"     >> "$GITHUB_ENV"

          # ìƒˆ ì˜ìƒì´ë©´ í”Œë˜ê·¸ ì„¸íŒ…
          if [ "$LATEST_URL" != "$LAST_URL" ]; then
            echo "should_notify=true"  >> "$GITHUB_ENV"
          else
            echo "should_notify=false" >> "$GITHUB_ENV"
          fi

      # 4) ìƒˆ ì˜ìƒì¼ ë•Œë§Œ ë””ìŠ¤ì½”ë“œ ì „ì†¡
      - name: Send to Discord
        if: env.should_notify == 'true'
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"ğŸ“¢Â NewÂ videoÂ uploaded!\n${{ env.LATEST_URL }}\"}" \
               "https://discord.com/api/webhooks/1384370263109533748/tCL76BCnNgVRXO6f92Sj3ObpquQivGSGWWtL_M2rrT87wezoplKiM5OTv758DlUw-vxe"

      # 5) ì „ì†¡í–ˆìœ¼ë©´ URL ê¸°ë¡ ê°±ì‹  & ì»¤ë°‹
      - name: Save last URL
        if: env.should_notify == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          message: "ğŸ”„Â UpdateÂ last_notified.json"
          add: "last_notified.json"
          default_author: github_actions
