name: YouTube â†’ Discord Notifier

on:
  schedule:
    - cron: '*/10 * * * *'    # 10ë¶„ë§ˆë‹¤
  workflow_dispatch:          # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      # 1) ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v3

      # 2) jq ì„¤ì¹˜ (JSON íŒŒì‹±ìš©)
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 3) ìµœì‹  ì˜ìƒ URL ì¶”ì¶œ & ì´ì „ URL ë¹„êµ
      - name: Get latest video
        id: get_video
        run: |
          # ---- ì„¤ì • ----
          CHANNEL_ID="UCHKW0jcgmONEp7-KQ-0T8IA"
          FEED_URL="https://www.youtube.com/feeds/videos.xml?channel_id=$CHANNEL_ID"
          DISCORD_WEBHOOK="https://discord.com/api/webhooks/1384370263109533748/tCL76BCnNgVRXO6f92Sj3ObpquQivGSGWWtL_M2rrT87wezoplKiM5OTv758DlUw-vxe"
          # ---------------

          # RSSì—ì„œ ì²« ë²ˆì§¸ <yt:videoId> ê°’ë§Œ ì¶”ì¶œ â†’ ì˜ìƒ URL ìƒì„±
          VIDEO_ID=$(curl -s "$FEED_URL" | grep -m1 -oP '(?<=<yt:videoId>)[^<]+')
          if [ -z "$VIDEO_ID" ]; then
            echo "âŒ  ì˜ìƒ ID ì¶”ì¶œ ì‹¤íŒ¨"; exit 1
          fi
          LATEST_URL="https://www.youtube.com/watch?v=$VIDEO_ID"

          # ì´ì „ì— ë³´ë‚¸ URL ì½ê¸°
          if [ -f last_notified.json ]; then
            LAST_URL=$(jq -r '.url' last_notified.json)
          else
            LAST_URL=""
          fi

          echo "LATEST_URL=$LATEST_URL" >> $GITHUB_ENV
          echo "LAST_URL=$LAST_URL"     >> $GITHUB_ENV

          if [ "$LATEST_URL" != "$LAST_URL" ]; then
            echo "should_notify=true" >> $GITHUB_ENV
          else
            echo "should_notify=false" >> $GITHUB_ENV
          fi

      # 4) ìƒˆ ì˜ìƒì¼ ë•Œë§Œ ë””ìŠ¤ì½”ë“œ ì „ì†¡
      - name: Send to Discord
        if: env.should_notify == 'true'
        run: |
          DISCORD_WEBHOOK="https://discord.com/api/webhooks/1384370263109533748/tCL76BCnNgVRXO6f92Sj3ObpquQivGSGWWtL_M2rrT87wezoplKiM5OTv758DlUw-vxe"
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"ğŸ“¢  New video uploaded!\n${{ env.LATEST_URL }}\"}" \
               "$DISCORD_WEBHOOK"

      # 5) URL ê°±ì‹  í›„ ì»¤ë°‹
      - name: Save latest URL
        if: env.should_notify == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          add: "last_notified.json"
          message: "ğŸ”„ update last_notified.json"
        env:
          LATEST_URL: ${{ env.LATEST_URL }}
        run: |
          echo "{\"url\":\"$LATEST_URL\"}" > last_notified.json

