name: YouTube to Discord Notifier

on:
  schedule:
    - cron: '*/10 * * * *'  
  workflow_dispatch:    

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

     - name: Check latest video
         id: check_video
        run: |
             CHANNEL_ID=UCHKW0jgcmoNEp7-KQ-0T8IA
             FEED_URL="https://www.youtube.com/feeds/videos.xml?channel_id=$CHANNEL_ID"
             LATEST_URL=$(curl -s "$FEED_URL" | grep -oP '(?<=<entry>).*?(?=</entry>)' | head -n 1 | grep -oP '(?<=<link rel="alternate" href=")[^"]+')
    
          echo "Latest video URL: $LATEST_URL"
          
          if [ -f last_notified.json ]; then
            LAST_URL=$(cat last_notified.json | jq -r '.url')
          else
            LAST_URL=""
          fi

          echo "Last notified URL: $LAST_URL"

          if [ "$LATEST_URL" != "$LAST_URL" ]; then
            echo "New video found!"
            echo "{\"url\": \"$LATEST_URL\"}" > last_notified.json
            echo "should_notify=true" >> $GITHUB_ENV
            echo "LATEST_URL=$LATEST_URL" >> $GITHUB_ENV
          else
            echo "No new video."
            echo "should_notify=false" >> $GITHUB_ENV
          fi

      - name: Send to Discord
        if: env.should_notify == 'true'
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"ðŸ“¢ New lineup!\n${{ env.LATEST_URL }}\"}" \
            https://discord.com/api/webhooks/1384370263109533748/tCL76BCnNgVRXO6f92Sj3ObpquQivGSGWWtL_M2rrT87wezoplKiM5OTv758DlUw-vxe
